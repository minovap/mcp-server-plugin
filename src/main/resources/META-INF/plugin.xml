<?xml version="1.0" encoding="UTF-8"?>
<idea-plugin>
    <id>com.intellij.mcpServer</id>
    <n>MCP Server</n>
    <version>1.0.16</version>
    <description><![CDATA[
    MCP (Model Context Protocol) Server for IntelliJ IDEs
    <p>
        This plugin integrates the MCP server into IntelliJ-based IDEs, enabling seamless communication between
        Large Language Models (LLMs) and your development environment. It provides tools for interacting with the IDE,
        including:
    </p>
    <ul>
        <li>Reading the current file</li>
        <li>Executing terminal commands</li>
        <li>Setting breakpoints</li>
        <li>Searching project files</li>
        <li>And more</li>
    </ul>
    <p>
        To connect with Claude Desktop, you must install and register the MCP Proxy in Claude.
    </p>
    <p>
        For detailed instructions, visit the
        <a href="https://github.com/JetBrains/mcp-jetbrains/blob/main/README.md" target="_blank">GitHub repository</a>.
    </p>
  ]]></description>
    <vendor>JetBrains</vendor>

    <depends>com.intellij.modules.lang</depends>
    <depends config-file="mcpServer-terminal.xml" optional="true">org.jetbrains.plugins.terminal</depends>
    <depends config-file="mcpServer-git.xml" optional="true">Git4Idea</depends>

    <extensionPoints>
        <extensionPoint name="mcpTool"
                        interface="org.jetbrains.mcpserverplugin.McpTool"
                        dynamic="true"/>
    </extensionPoints>

    <extensions defaultExtensionNs="com.intellij">
        <httpRequestHandler implementation="org.jetbrains.ide.mcp.MCPService"/>
        <httpRequestHandler implementation="org.jetbrains.mcpserverplugin.MCPWebSocketService"/>
        <notificationGroup id="MCPServerPlugin" displayType="BALLOON"/>
        <postStartupActivity implementation="org.jetbrains.mcpserverplugin.MCPServerStartupValidator"/>
        
        <!-- Settings service and configurable -->
        <applicationService serviceImplementation="org.jetbrains.mcpserverplugin.settings.PluginSettings"/>
        <applicationService serviceImplementation="org.jetbrains.mcpserverplugin.actions.ui.LLMTodoDialogSettings"/>
        <applicationConfigurable
            parentId="tools"
            id="org.jetbrains.mcpserverplugin.settings.MCPConfigurable"
            instance="org.jetbrains.mcpserverplugin.settings.MCPConfigurable"
            displayName="MCP Server"/>
            
        <!-- LLM Todo service -->
        <projectService serviceImplementation="org.jetbrains.mcpserverplugin.llmtodo.LLMTodoService"/>
    </extensions>
    
    <actions>
        <!-- LLM group under Tools menu -->
        <group id="org.jetbrains.mcpserverplugin.actions.LLMGroup" 
               text="LLM"
               popup="true">
            <add-to-group group-id="ToolsMenu" anchor="last"/>
            
            <action id="org.jetbrains.mcpserverplugin.actions.Connect"
                    class="org.jetbrains.mcpserverplugin.actions.ConnectAction"
                    text="Connect"
                    description="Connect to MCP server"
                    icon="org.jetbrains.mcpserverplugin.icons.ClaudeIcons.CLAUDE_ICON"/>
                    
            <action id="org.jetbrains.mcpserverplugin.actions.FindFile"
                    class="org.jetbrains.mcpserverplugin.actions.FindFileAction"
                    text="Find File Test"
                    description="Test the FileFinderUtils.findFileInProject functionality"/>
                    
            <action id="org.jetbrains.mcpserverplugin.actions.FindDirectory"
                    class="org.jetbrains.mcpserverplugin.actions.FindDirectoryAction"
                    text="Find Directory Test"
                    description="Test the FileFinderUtils.findDirectoryInProject functionality"/>
                    
            <action id="org.jetbrains.mcpserverplugin.actions.InstallPlugin"
                    class="org.jetbrains.mcpserverplugin.actions.InstallPluginAction"
                    text="Install Plugin and Restart"
                    description="Install the latest built plugin and restart the IDE"
                    icon="AllIcons.Actions.Install"/>
        </group>
        
        <!-- New Chat Context Groups -->
        <group id="org.jetbrains.mcpserverplugin.actions.EditorNewChatGroup" 
               class="org.jetbrains.mcpserverplugin.actions.PromptContextGroup"
               popup="true">
            <add-to-group group-id="EditorPopupMenu" anchor="first"/>
            <add-to-group group-id="GenerateGroup" anchor="first"/>
            
            <!-- Default action when clicking directly on the group -->
            <action id="org.jetbrains.mcpserverplugin.actions.EditorNewChatDefault"
                    class="org.jetbrains.mcpserverplugin.actions.SendCodeToClaudeAction"
                    text="Default"
                    description="Use default template with editor selection" />
        </group>
        
        <group id="org.jetbrains.mcpserverplugin.actions.FileNewChatGroup"
               class="org.jetbrains.mcpserverplugin.actions.FilePromptContextGroup"
               popup="true">
            <add-to-group group-id="ProjectViewPopupMenu" anchor="first" />
            
            <!-- Default action when clicking directly on the group -->
            <action id="org.jetbrains.mcpserverplugin.actions.FileNewChatDefault"
                    class="org.jetbrains.mcpserverplugin.actions.SendFilesToClaudeAction"
                    text="Default"
                    description="Use default template with selected files" />
        </group>
        
        <!-- Add divider after New Chat groups -->
        <separator>
            <add-to-group group-id="EditorPopupMenu" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.EditorNewChatGroup"/>
            <add-to-group group-id="GenerateGroup" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.EditorNewChatGroup"/>
            <add-to-group group-id="ProjectViewPopupMenu" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.FileNewChatGroup" />
        </separator>
        
        <!-- Append Context Groups -->
        <group id="org.jetbrains.mcpserverplugin.actions.EditorAppendGroup" 
               class="org.jetbrains.mcpserverplugin.actions.PromptContextGroup$Append"
               popup="true">
            <add-to-group group-id="EditorPopupMenu" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.EditorNewChatGroup"/>
            <add-to-group group-id="GenerateGroup" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.EditorNewChatGroup"/>
            
            <!-- Default action when clicking directly on the group -->
            <action id="org.jetbrains.mcpserverplugin.actions.EditorAppendDefault"
                    class="org.jetbrains.mcpserverplugin.actions.SendCodeToClaudeAction"
                    text="Default"
                    description="Use default template with editor selection">
                <konstruktor>
                    <param value="org.jetbrains.mcpserverplugin.actions.EditorAppendDefault"/>
                    <param value="Default"/>
                    <param value="default"/>
                    <param value="false"/>
                </konstruktor>
            </action>
        </group>
        
        <group id="org.jetbrains.mcpserverplugin.actions.FileAppendGroup"
               class="org.jetbrains.mcpserverplugin.actions.FilePromptContextGroup$Append"
               popup="true">
            <add-to-group group-id="ProjectViewPopupMenu" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.FileNewChatGroup" />
            
            <!-- Default action when clicking directly on the group -->
            <action id="org.jetbrains.mcpserverplugin.actions.FileAppendDefault"
                    class="org.jetbrains.mcpserverplugin.actions.SendFilesToClaudeAction"
                    text="Default"
                    description="Use default template with selected files">
                <konstruktor>
                    <param value="org.jetbrains.mcpserverplugin.actions.FileAppendDefault"/>
                    <param value="Default"/>
                    <param value="default"/>
                    <param value="false"/>
                </konstruktor>
            </action>
        </group>
        
        <!-- Add divider after Append groups -->
        <separator>
            <add-to-group group-id="EditorPopupMenu" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.EditorAppendGroup"/>
            <add-to-group group-id="GenerateGroup" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.EditorAppendGroup"/>
            <add-to-group group-id="ProjectViewPopupMenu" anchor="after" relative-to-action="org.jetbrains.mcpserverplugin.actions.FileAppendGroup" />
        </separator>
    </actions>
</idea-plugin>